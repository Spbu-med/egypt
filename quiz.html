<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: '#ff0033', dark: '#0a0a0a', glass: 'rgba(255, 255, 255, 0.05)' }, fontFamily: { cairo: ['Cairo', 'sans-serif'] }, animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' } } }
        }
    </script>
    <style>
        body { background-color: #0a0a0a; color: white; font-family: 'Cairo', sans-serif; background: radial-gradient(circle at 50% 50%, #1a0000 0%, #0a0a0a 100%); min-height: 100vh; overflow-x: hidden; }
        .glass-panel { background: rgba(20, 20, 20, 0.75); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 20px 50px rgba(0,0,0,0.6); }
        .custom-input { background: rgba(0,0,0,0.4); border: 2px solid rgba(255,255,255,0.1); color: white; transition: 0.3s all ease; }
        .custom-input:focus { border-color: #ff0033; outline: none; box-shadow: 0 0 20px rgba(255, 0, 51, 0.15); background: rgba(0,0,0,0.8); transform: translateY(-2px); }
        .option-card { transition: all 0.2s ease; position: relative; overflow: hidden; }
        .option-card:hover { border-color: rgba(255, 0, 51, 0.6); background: rgba(255, 0, 51, 0.05); transform: translateX(5px); }
        .option-selected { border-color: #ff0033 !important; background: linear-gradient(90deg, rgba(255,0,51,0.2) 0%, transparent 100%) !important; box-shadow: -4px 0 0 #ff0033 inset; }
        .review-card-correct { background: linear-gradient(90deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.05) 100%) !important; border: 1px solid #22c55e !important; }
        .review-card-wrong { background: linear-gradient(90deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%) !important; border: 1px solid #ef4444 !important; opacity: 0.9; }
        .review-card-neutral { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); opacity: 0.6; }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .explanation-box { background: linear-gradient(180deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%); border-left: 4px solid #3b82f6; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="glass-panel h-16 flex items-center justify-between px-6 z-30 border-b border-white/5 relative">
        <h1 class="text-lg md:text-xl font-bold flex items-center gap-3 tracking-wide">
            <i class="fa-solid fa-file-signature text-primary animate-pulse-slow"></i> 
            <span id="quiz-title-display" class="bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">Exam</span>
        </h1>
        <a id="exit-btn" href="quizzes-menu.html" class="group flex items-center gap-2 text-sm text-gray-500 hover:text-white transition-colors">
            <span class="hidden md:block transition-transform group-hover:-translate-x-1">Exit Exam</span>
            <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-primary group-hover:text-white transition-all"><i class="fa-solid fa-xmark"></i></div>
        </a>
    </header>

    <div id="progress-container" class="hidden w-full h-1 bg-gray-800 z-20 absolute top-16 left-0"><div id="progress-bar" class="h-full bg-primary transition-all duration-500 ease-out" style="width: 0%"></div></div>

    <main class="flex-1 flex items-center justify-center p-4 relative overflow-hidden">
        <div id="start-screen" class="glass-panel max-w-md w-full p-8 md:p-10 rounded-3xl text-center fade-in border border-white/10 relative overflow-hidden">
            <div class="w-24 h-24 bg-gradient-to-br from-gray-800 to-black rounded-full flex items-center justify-center mx-auto mb-8 border border-white/10 shadow-2xl"><i class="fa-solid fa-user-graduate text-4xl text-primary"></i></div>
            <h2 class="text-3xl font-black mb-2 tracking-tight">Ready to Start?</h2>
            <p class="text-gray-400 mb-8 text-sm leading-relaxed">Please enter your full name to begin.</p>
            <div class="text-left mb-8 group"><label class="text-xs text-primary font-bold uppercase tracking-widest ml-1 mb-2 block">Student Name</label><input type="text" id="student-name-input" placeholder="Type your name here..." class="custom-input w-full rounded-xl p-4 text-lg placeholder-gray-600"></div>
            <div class="flex justify-between items-center text-xs font-mono text-gray-500 mb-8 px-4 py-3 bg-white/5 rounded-lg border border-white/5">
                <span class="flex items-center gap-2"><i class="fa-solid fa-list-check text-primary"></i> <span id="q-total-start">--</span> Qs</span>
                <div class="h-4 w-[1px] bg-white/10"></div>
                <span class="flex items-center gap-2"><i class="fa-regular fa-clock text-primary"></i> 45 Mins</span>
            </div>
            <button onclick="startQuiz()" class="w-full bg-gradient-to-r from-primary to-red-700 hover:from-red-600 hover:to-red-800 text-white font-bold py-4 rounded-xl shadow-[0_10px_30px_rgba(255,0,51,0.3)] transition-all transform hover:scale-[1.02] flex items-center justify-center gap-3"><span>Start Exam</span> <i class="fa-solid fa-arrow-right-long"></i></button>
        </div>

        <div id="quiz-screen" class="hidden flex-col w-full max-w-4xl h-full md:h-auto fade-in">
            <div class="flex justify-between items-end mb-4 px-2">
                <div class="text-sm font-medium text-gray-400">Question <span id="q-number" class="text-white text-2xl font-bold font-cairo mx-1">1</span> / <span id="q-total" class="text-gray-500">--</span></div>
                <div class="bg-black/40 text-primary px-4 py-2 rounded-lg font-mono font-bold border border-primary/20 flex items-center gap-2 shadow-lg backdrop-blur-md"><i class="fa-regular fa-clock animate-pulse"></i> <span id="timer-display">45:00</span></div>
            </div>
            <div class="glass-panel flex-1 md:flex-none rounded-2xl p-6 md:p-10 relative overflow-y-auto border-t-4 border-t-primary">
                <h2 id="q-text" class="text-xl md:text-2xl font-bold mb-8 leading-relaxed text-gray-100">Loading...</h2>
                <div id="options-container" class="space-y-3 pb-20 md:pb-0"></div>
            </div>
            <div class="flex justify-between mt-6">
                <button onclick="prevQuestion()" id="prev-btn" class="px-6 py-3 rounded-xl border border-white/10 hover:bg-white/5 text-gray-400 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition flex items-center gap-2"><i class="fa-solid fa-chevron-left"></i> Prev</button>
                <button onclick="nextQuestion()" id="next-btn" class="px-8 py-3 rounded-xl bg-white text-black font-bold hover:bg-gray-200 shadow-lg transition flex items-center gap-2 transform active:scale-95">Next <i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>

        <div id="result-screen" class="hidden glass-panel max-w-md w-full p-8 rounded-3xl text-center border border-white/10 fade-in relative z-50">
            <div class="w-28 h-28 rounded-full border-4 border-primary mx-auto flex flex-col items-center justify-center mb-6 shadow-[0_0_40px_rgba(255,0,51,0.4)] bg-black relative z-10">
                <span id="final-score" class="text-5xl font-black text-white leading-none mt-1">0</span>
                <span class="text-[10px] text-gray-400 uppercase tracking-widest mt-1">Score</span>
            </div>
            <h2 class="text-2xl font-bold mb-1">Exam Completed</h2>
            <p id="student-name-display" class="text-primary font-bold text-lg mb-4"></p>
            <div id="save-status" class="mb-8 text-xs font-mono py-2 px-4 rounded-full bg-white/5 inline-flex items-center gap-2 border border-white/5"><i class="fa-solid fa-spinner fa-spin text-primary"></i> <span class="text-gray-400">Syncing...</span></div>
            <div class="space-y-3 relative z-10">
                <button onclick="showReview()" class="w-full py-3.5 bg-gradient-to-r from-gray-800 to-gray-900 border border-white/10 hover:border-primary/50 text-white font-bold rounded-xl transition-all flex items-center justify-center gap-2 group"><i class="fa-solid fa-eye text-primary group-hover:scale-110 transition-transform"></i> Review Answers</button>
                <div class="flex gap-3">
                    <button onclick="location.reload()" class="flex-1 py-3 border border-white/10 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 text-sm transition font-medium">Retake</button>
                    <a id="rank-btn" href="#" class="flex-1 py-3 bg-primary text-white rounded-xl hover:bg-red-700 text-sm flex items-center justify-center transition font-bold shadow-lg">Rank <i class="fa-solid fa-trophy ml-2"></i></a>
                </div>
                <a href="index.html" class="block w-full py-3 mt-2 border border-white/5 rounded-xl text-gray-500 hover:text-white hover:bg-white/5 text-sm transition flex items-center justify-center gap-2"><i class="fa-solid fa-house"></i> Back to Home</a>
            </div>
        </div>

        <div id="review-screen" class="hidden absolute inset-0 bg-[#0a0a0a] z-[60] flex flex-col fade-in">
            <div class="glass-panel p-4 flex justify-between items-center border-b border-white/10 shrink-0 sticky top-0 z-50">
                <h2 class="font-bold text-lg flex items-center gap-2 text-white"><i class="fa-solid fa-list-check text-primary"></i> Model Answer</h2>
                <button onclick="closeReview()" class="bg-white/5 hover:bg-white/10 border border-white/10 text-gray-300 px-4 py-2 rounded-lg transition text-sm">Close <i class="fa-solid fa-xmark ml-1"></i></button>
            </div>
            <div id="review-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 max-w-4xl mx-auto w-full pb-20 custom-scrollbar"></div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyASq2nOBpRMJtKqWWvTDD4hyGmEOp5cOnI", authDomain: "spbu-med-platform.firebaseapp.com", projectId: "spbu-med-platform", storageBucket: "spbu-med-platform.firebasestorage.app", messagingSenderId: "227576463828", appId: "1:227576463828:web:1114162c17881bf5da9641" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- FULL QUESTION BANK WITH DETAILED EXPLANATIONS ---
        const questionBank = {
            "bioethics": [
                { id: 1, q: "Who is credited with coining the term 'Bioethics' in 1927?", options: ["Van Rensselaer Potter", "André Hellegers", "Fritz Jahr", "Stephen Toulmin"], a: 2, explanation: "Fritz Jahr, a German pastor, coined the term 'Bio-Ethik' in 1927 in an article titled 'Bio-Ethics: Reviewing the Ethical Relations of Humans towards Animals and Plants'. While Van Rensselaer Potter popularized the term in the 1970s (Bioethics: Bridge to the Future), Jahr is the historical originator." },
                { id: 2, q: "Which perspective asks: 'What do I owe to the common good?'", options: ["Ethics of Virtue", "Social Relationships", "Cosmopolitan", "Deontology"], a: 2, explanation: "The Cosmopolitan perspective takes a broad view, focusing on duties to society, public interest, and the common good. In contrast, Virtue Ethics focuses on the agent's character, and Deontology focuses on strict adherence to rules/duties regardless of the broader 'good'." },
                { id: 3, q: "Which was NOT a core factor for Bioethics emergence in 1960s?", options: ["Technical progress", "Environmental agenda", "Collapse of religion", "Shift to chronic diseases"], a: 2, explanation: "Bioethics emerged due to rapid Technical progress (dialysis, ventilators), the Environmental agenda, Civil rights movements, and Institutional changes. It was NOT caused by a 'collapse of religion', but rather by the need for secular moral guidance in a pluralistic society." },
                { id: 4, q: "Metaethics is primarily concerned with:", options: ["Consequences", "Meaning of moral terms", "Character", "Universalizability"], a: 1, explanation: "Metaethics deals with the nature, origin, and meaning of ethical concepts (e.g., 'What does *right* actually mean?'). Normative ethics (like Deontology/Utilitarianism) asks 'What *is* right?'." },
                { id: 5, q: "What is 'Casuistry'?", options: ["Principlism", "Case-based reasoning", "Communitarianism", "Reflective Equilibrium"], a: 1, explanation: "Casuistry is a method of solving moral problems by analyzing specific cases (paradigms) and comparing them, rather than starting from abstract principles. It focuses on the practical application of ethics to particular circumstances." },
                { id: 6, q: "Bruno Latour's questioning of 'Interrelations of humans and non-humans' raises:", options: ["Human autonomy", "Conquering death", "Are non-humans moral agents?", "Natural law"], a: 2, explanation: "Latour's Actor-Network Theory explores the sociology of science, questioning if non-human entities (like technology, viruses, or animals) act as agents in a network, challenging the traditional view that only humans are moral agents." },
                { id: 7, q: "'Wide Reflective Equilibrium' is a technique of:", options: ["Deontology", "Utilitarianism", "Applied Ethics", "Virtue Ethics"], a: 2, explanation: "Wide Reflective Equilibrium (developed by John Rawls) is a method used in Applied Ethics to achieve coherence between our specific moral judgments, general principles, and background theories." },
                { id: 8, q: "Isaiah Berlin described 'negative liberty' as:", options: ["Self-mastery", "Absence of coercion", "Consciousness of rules", "Ruling oneself"], a: 1, explanation: "Negative Liberty is the 'freedom FROM' interference or coercion by others. Positive Liberty is 'freedom TO' achieve self-mastery and realize one's potential." },
                { id: 9, q: "Who stated: 'I am autonomous if I rule me, and no one else rules I'?", options: ["Kant", "Joel Feinberg", "Scanlon", "Beauchamp"], a: 1, explanation: "This quote is attributed to Joel Feinberg, emphasizing the core concept of personal sovereignty and independence from external control as the essence of autonomy." },
                { id: 10, q: "Kant's concept of Autonomy requires principles to meet:", options: ["Happiness", "Universality", "Utility", "Practical reason"], a: 1, explanation: "For Kant, true autonomy isn't just doing what you want; it's acting according to the Categorical Imperative—rules that you could will to become Universal Laws for everyone." },
                { id: 11, q: "What makes autonomy 'morally powerful'?", options: ["Social stability", "Moral individuality", "Efficiency", "Dogma"], a: 1, explanation: "Autonomy is powerful because it represents 'Moral Individuality' and 'Voluntarism'—the capacity to make one's own moral choices and be responsible for them, separating the self from the collective." },
                { id: 12, q: "Weak vs Strong Paternalism is based on:", options: ["Legality", "Competence", "Harm severity", "Force"], a: 1, explanation: "The distinction lies in the patient's competence. Weak Paternalism intervenes only if the person is NOT competent (e.g., a child, delirious). Strong Paternalism overrides the choices of a fully competent adult for their own good." },
                { id: 13, q: "The Ottoman document from 1539 is an example of:", options: ["Organ transplant", "Surgery waiver", "Confidentiality", "Experimentation"], a: 1, explanation: "This historical document was a waiver/contract where a patient (or guardian) agreed not to prosecute the surgeon if the surgery failed. It is an early, crude form of consent focused on liability." },
                { id: 14, q: "In Walter Reed's Yellow Fever experiments, death compensation was:", options: ["Pension", "$500", "$100", "$200"], a: 2, explanation: "Volunteers signed a contract and were paid $100 in gold for participating. If they contracted yellow fever and died, an additional $100 was paid to their heirs." },
                { id: 15, q: "Which is NOT a Paternalism/Autonomy dilemma listed?", options: ["Overriding Refusals", "Partial Disclosures", "Excessive Risk", "Mandatory Vaccinations"], a: 3, explanation: "While vaccinations can be paternalistic, the specific lecture context lists 'Overriding Refusals', 'Partial Disclosures', and 'Preventing Excessive Risk' as the key clinical dilemmas in the doctor-patient relationship." },
                { id: 16, q: "Model emphasizing 'Love is the true medicine':", options: ["Hippocratic", "Paracelsus", "Deontological", "Social"], a: 1, explanation: "Paracelsus (Theophrastus von Hohenheim) challenged the technical focus of Galenic medicine, emphasizing the spiritual and emotional connection, stating 'The highest ground of medicine is love'." },
                { id: 17, q: "Deontological Model (Nikolay Petrov) is characterized by:", options: ["Utility", "Strict duty", "Virtue", "Autonomy"], a: 1, explanation: "Deontology is the 'Ethics of Duty'. Nikolay Petrov emphasized strict adherence to professional duties, rules, and the 'sense of duty' in oncology and surgery." },
                { id: 18, q: "Physician-Patient Privilege (PPP) is:", options: ["Refusal right", "Legal protection in court", "Records right", "Nonmaleficence"], a: 1, explanation: "PPP is a specific legal concept (different from general confidentiality) that protects the confidentiality of communication between doctor and patient from being forced into evidence in court." },
                { id: 19, q: "Public Health definition (1988 report):", options: ["No disease", "Well-being", "Collective action", "Free care"], a: 2, explanation: "The Institute of Medicine (IOM) 1988 report defined Public Health as 'What we as a society do collectively to assure the conditions in which people can be healthy'." },
                { id: 20, q: "Malady distinction: Disease vs Illness is:", options: ["Objective vs Subjective", "Mental vs Physical", "Infectious vs Non", "Acute vs Chronic"], a: 0, explanation: "Disease refers to the objective biological pathology or malfunction. Illness refers to the subjective experience of suffering and loss of function perceived by the patient." },
                { id: 21, q: "Principle addressing balancing benefit/harm for population:", options: ["Veracity", "Fidelity", "Utility", "Solidarity"], a: 2, explanation: "The Principle of Utility in Public Health focuses on maximizing the net benefit (health outcomes) over harm/cost for the largest number of people in the population." },
                { id: 22, q: "In Russia, consent for 'Immature minors' (6-15) requires:", options: ["Own consent", "Unassisted", "Legal rep", "No consent"], a: 2, explanation: "Under Russian law, for minors between 6 and 15 years old (classified as 'immature'), the informed consent of a legal representative (parent/guardian) is mandatory for medical intervention." },
                { id: 23, q: "Golden Rule 'What you wish upon others...' is:", options: ["Directive", "Negative", "Empathetic", "Categorical"], a: 2, explanation: "The phrasing 'What you wish upon others, you wish upon yourself' reflects the Empathetic or Responsive form, focusing on mutual feeling and reciprocity rather than just a negative restriction." },
                { id: 24, q: "Ethics of Virtue: Good judgement = Virtue + ...?", options: ["Divine command", "Utility calc", "Practical reason", "Maxims"], a: 2, explanation: "In Virtue Ethics (Aristotle), good moral judgment requires a Virtuous Character combined with 'Phronesis' (Seasoned Practical Reason) to know how to apply virtue in context." },
                { id: 25, q: "Autonomy as 'sovereignty in deciding what to believe' defined by:", options: ["Scanlon", "Feinberg", "Kant", "Kohlberg"], a: 0, explanation: "Thomas Scanlon defined autonomy as the 'sovereignty in deciding what to believe and how to act' based on one's own reasons, emphasizing intellectual independence." },
                { id: 26, q: "Communitarianism is characterized by:", options: ["Rules", "Social context", "Consequences", "Professionalism"], a: 1, explanation: "Communitarianism critiques the focus on the isolated individual. It emphasizes that individuals are embedded in a social context, community values, and traditions." },
                { id: 27, q: "5th element of Informed Consent:", options: ["Status", "Recommendation", "Voluntariness", "Guardian"], a: 2, explanation: "The 5 elements are: 1. Disclosure, 2. Understanding, 3. Voluntariness (freedom from coercion), 4. Competence, 5. Consent (Decision)." },
                { id: 28, q: "Hippocratic Model contrasts with Bioethics in:", options: ["Euthanasia", "Secrecy", "Paternalism", "Nonmaleficence"], a: 2, explanation: "The traditional Hippocratic model is Paternalistic (the doctor acts as a benevolent parent). Modern Bioethics emphasizes Patient Autonomy and shared decision-making." },
                { id: 29, q: "3rd cornerstone of Bioethics Interdisciplinarity:", options: ["Duties", "Common good", "Virtue", "Death"], a: 1, explanation: "The 3 cornerstones are: 1. Duties to self/others (Deontology/Rights), 2. Rights/Justice, 3. The Common Good (Public Interest/Solidarity)." },
                { id: 30, q: "Autonomy according to Kohlberg involves:", options: ["Consciousness of rules", "Free choice", "Adults only", "No coercion"], a: 0, explanation: "Lawrence Kohlberg viewed autonomy as a high stage of moral development involving 'Deliberate consciousness about obedience to rules'—choosing to follow rules because they are just, not just out of habit." },
                { id: 31, q: "Overriding Refusals is a conflict between:", options: ["Justice/Beneficence", "Nonmaleficence/Utility", "Autonomy/Beneficence", "Veracity/Justice"], a: 2, explanation: "Overriding a patient's refusal means going against their Autonomy in order to provide them a medical benefit (Beneficence) - a classic paternalistic conflict." },
                { id: 32, q: "Privacy and PPP are mandatory for:", options: ["Rationality", "Voluntarism", "Autonomous being", "Agency"], a: 2, explanation: "Respecting privacy and physician-patient privilege is essential to treat the patient as an 'Autonomous being' who has the right to control their own life and information." }
            ],
            "lec1": [
                { id: 1, q: "J.J. Thomson's cathode ray deflection proved particles were:", options: ["Massive.", "Negatively charged.", "Inert.", "Positive."], a: 1, explanation: "In the cathode ray tube, the ray was deflected AWAY from the negative plate and TOWARDS the positive plate. Since like charges repel and opposites attract, this proved the particles (electrons) were negatively charged." },
                { id: 2, q: "Copper (69% Cu-63, 31% Cu-65). Average mass calc:", options: ["(63+65)/2", "Weighted average", "Sum of mass", "Difference"], a: 1, explanation: "Atomic mass is a weighted average, not a simple average. Calculation: (Mass_isotope1 × Abundance1) + (Mass_isotope2 × Abundance2). Here: (62.93 × 0.69) + (64.93 × 0.31) ≈ 63.55 amu." },
                { id: 3, q: "Gas density formula d = PM/RT implies highest density for:", options: ["CH4", "O2", "CO2", "SF6"], a: 3, explanation: "The formula d = PM/RT shows that at constant Pressure (P) and Temperature (T), density (d) is directly proportional to Molar Mass (M). SF6 has the highest molar mass (~146 g/mol) compared to the others, so it is the densest." },
                { id: 4, q: "Rutherford's experiment disproved Plum Pudding by showing:", options: ["No deflection.", "Large angle deflection.", "Absorption.", "Reflection."], a: 1, explanation: "The Plum Pudding model predicted alpha particles would pass through with minimal deflection. Rutherford found that some were deflected at very large angles (even back at the source), implying a dense, positively charged nucleus." },
                { id: 5, q: "Total P = 12 atm, 1 mol N2 + 3 mol H2. P(H2) = ?", options: ["3 atm", "9 atm", "4 atm", "6 atm"], a: 1, explanation: "Using Dalton's Law: Partial Pressure = Total Pressure × Mole Fraction. Total moles = 1 + 3 = 4. Mole fraction of H2 = 3/4 = 0.75. P(H2) = 12 atm × 0.75 = 9 atm." },
                { id: 6, q: "Van der Waals 'a' constant corrects for:", options: ["Volume.", "Forces.", "Temp.", "Moles."], a: 1, explanation: "The Van der Waals equation is (P + an²/V²)(V - nb) = nRT. The term 'a' corrects for intermolecular attractive forces (pressure correction), while 'b' corrects for the finite volume of the particles." },
                { id: 7, q: "Molecules in 0.04g Saccharin (M=183.18)?", options: ["1.31e20", "2.5e21", "6.02e23", "9.17e20"], a: 0, explanation: "Step 1: Moles = Mass / Molar Mass = 0.04 g / 183.18 g/mol ≈ 2.18e-4 mol. Step 2: Molecules = Moles × Avogadro's Number = 2.18e-4 × 6.022e23 ≈ 1.31 × 10^20." },
                { id: 8, q: "Structural isomers have:", options: ["Different formula.", "Same formula, diff connectivity.", "Same structure.", "Diff neutrons."], a: 1, explanation: "Isomers generally have the same molecular formula. Structural isomers specifically differ in how the atoms are connected (bonded) to each other." },
                { id: 9, q: "Double T (Kelvin) at constant P, Volume:", options: ["Halves.", "Doubles.", "Same.", "Quadruples."], a: 1, explanation: "According to Charles's Law (V1/T1 = V2/T2), volume is directly proportional to Absolute Temperature. If T doubles, V must double to maintain constant pressure." },
                { id: 10, q: "Millikan's drop experiment found:", options: ["Mass.", "Charge.", "e/m ratio.", "Nucleus."], a: 1, explanation: "Robert Millikan determined the elementary charge (e = 1.602 x 10^-19 C) by observing charged oil droplets suspended in an electric field." },
                { id: 11, q: "Diatomic element?", options: ["He", "S", "I", "C"], a: 2, explanation: "Iodine exists as diatomic molecules (I2). Helium (He) is monatomic. Sulfur usually exists as S8. Carbon forms network solids." },
                { id: 12, q: "Mass number (A) is:", options: ["P+e", "P+N", "N+e", "Avg mass"], a: 1, explanation: "The Mass Number (A) is the integer sum of protons (Z) and neutrons (N) in the nucleus. It is not the average atomic mass." },
                { id: 13, q: "Dalton's Law assumes gases:", options: ["Interact.", "Have volume.", "Act independently.", "Vary temp."], a: 2, explanation: "Dalton's Law of Partial Pressures assumes that gases in a mixture act independently; the presence of other gases does not affect the pressure exerted by a specific gas." },
                { id: 14, q: "Isotopes differ in:", options: ["Chemicals.", "Protons.", "Electrons.", "Neutrons."], a: 3, explanation: "Isotopes are atoms of the same element (same number of protons/electrons) but with different numbers of neutrons, leading to different mass numbers." },
                { id: 15, q: "V vs 1/P plot for ideal gas is:", options: ["Hyperbola.", "Linear.", "Parabola.", "Exp."], a: 1, explanation: "According to Boyle's Law (PV = k), V = k * (1/P). This is the equation of a straight line (y = mx) passing through the origin when V is plotted against 1/P." },
                { id: 16, q: "Empirical formula of C6H6:", options: ["C6H6", "CH", "CH2", "C3H3"], a: 1, explanation: "The empirical formula represents the simplest whole-number ratio of atoms. C6H6 can be divided by 6 to get the ratio 1:1, so the empirical formula is CH." },
                { id: 17, q: "Mass of 1 mole C-12:", options: ["12 amu", "12 g", "1 g", "6g"], a: 1, explanation: "This is the definition of the mole. One mole is the amount of substance containing as many particles as there are atoms in exactly 12 grams of pure Carbon-12." },
                { id: 18, q: "Molar volume depends on:", options: ["P & T.", "Weight.", "Chemistry.", "Neutrons."], a: 0, explanation: "For an ideal gas, the molar volume (V/n = RT/P) depends only on Pressure (P) and Temperature (T), not on the identity of the gas." },
                { id: 19, q: "Mass ~1/1800 of proton:", options: ["Neutron", "Electron", "Alpha", "Positron"], a: 1, explanation: "The electron is extremely light compared to nucleons. Its mass is approximately 1/1836 the mass of a proton." },
                { id: 20, q: "Cation has:", options: ["More e.", "Fewer e.", "Equal.", "No charge."], a: 1, explanation: "A cation is a positively charged ion. It becomes positive by losing negatively charged electrons, so it has fewer electrons than protons." }
            ],
            "lec2": [
                { id: 1, q: "Temp independent unit?", options: ["Molarity", "Molality", "Vol %", "g/L"], a: 1, explanation: "Molality (mol/kg solvent) is based on mass, which does not change with temperature. Molarity uses volume, which expands/contracts with temperature." },
                { id: 2, q: "Henry's Law Cg ~ ?", options: ["T", "P", "V", "M"], a: 1, explanation: "Henry's Law states C = kP. The solubility of a gas (C) is directly proportional to the partial pressure (P) of that gas above the liquid." },
                { id: 3, q: "i for AlCl3?", options: ["1", "3", "4", "2"], a: 2, explanation: "AlCl3 dissociates completely into Al³⁺ + 3Cl⁻. That is 1 + 3 = 4 particles. So the ideal Van't Hoff factor (i) is 4." },
                { id: 4, q: "Hypertonic effect on RBC:", options: ["Swell.", "Shrink.", "None.", "Divide."], a: 1, explanation: "In a hypertonic solution, the solute concentration outside is higher. Water flows out of the RBC via osmosis, causing it to shrink (Crenation)." },
                { id: 5, q: "Raoult's Law:", options: ["Psolv = Xsolv * P0", "P = Xsolute * P0", "P = P0/X", "P = X+P"], a: 0, explanation: "Raoult's Law states that the partial vapor pressure of a solvent in a solution (P_solv) is equal to the vapor pressure of the pure solvent (P0) multiplied by its mole fraction (X_solv)." },
                { id: 6, q: "Colligative property?", options: ["Density", "Viscosity", "Osmotic P", "Color"], a: 2, explanation: "Colligative properties depend only on the NUMBER of solute particles, not their identity. Examples: Osmotic Pressure, Boiling Point Elevation, Freezing Point Depression." },
                { id: 7, q: "Solute added, BP:", options: ["Drops.", "Rises.", "Same.", "Fluctuates."], a: 1, explanation: "Adding a non-volatile solute lowers the vapor pressure. A higher temperature is then needed to reach atmospheric pressure, so Boiling Point rises (Elevation)." },
                { id: 8, q: "Reverse Osmosis pressure:", options: ["= Osmotic", "< Osmotic", "> Osmotic", "Zero"], a: 2, explanation: "To reverse the natural flow of osmosis (forcing solvent from high solute to low solute concentration), you must apply a pressure GREATER than the osmotic pressure." },
                { id: 9, q: "0.5 mol in 200g solv. Molality?", options: ["0.25", "2.5", "0.1", "0.0025"], a: 1, explanation: "Molality (m) = moles of solute / kg of solvent. m = 0.5 mol / 0.200 kg = 2.5 m." },
                { id: 10, q: "Gas solubility vs T:", options: ["Increases.", "Decreases.", "Same.", "Pressure only."], a: 1, explanation: "Dissolving gases is usually exothermic. Increasing temperature adds energy, giving gas molecules enough kinetic energy to escape the solution, so solubility decreases." },
                { id: 11, q: "Weak electrolyte?", options: ["NaCl", "HCl", "HF", "NaOH"], a: 2, explanation: "NaCl, HCl, and NaOH are strong electrolytes (dissociate ~100%). HF is a weak acid and only partially dissociates, making it a weak electrolyte." },
                { id: 12, q: "Osmotic π = CRT, C is:", options: ["m", "M", "X", "w%"], a: 1, explanation: "In the Van't Hoff equation for osmotic pressure (π = iCRT), the concentration 'C' must be in Molarity (mol/L)." },
                { id: 13, q: "Real i < Predicted i due to:", options: ["Ion pairing.", "Polymers.", "Evap.", "H-bond."], a: 0, explanation: "In concentrated solutions, cations and anions attract each other strongly, forming 'ion pairs' that act as a single particle, effectively reducing the number of independent particles (i)." },
                { id: 14, q: "Supersaturated solution is:", options: ["Stable.", "Unstable.", "Equilibrium.", "Dilute."], a: 1, explanation: "A supersaturated solution holds more solute than is theoretically possible at that temperature. It is unstable; adding a seed crystal causes precipitation." },
                { id: 15, q: "FP Depression formula:", options: ["m*Kf", "M*Kf", "m/Kf", "PV"], a: 0, explanation: "The formula for Freezing Point Depression is ΔTf = i * Kf * m, where 'm' is molality." },
                { id: 16, q: "Immiscible pair?", options: ["Ethanol/Water", "Oil/Water", "Vinegar/Water", "Methanol/Water"], a: 1, explanation: "'Like dissolves like'. Water is polar. Oil is non-polar. Therefore, they do not mix (immiscible)." },
                { id: 17, q: "Mole fraction Xa:", options: ["na/L", "na/ntotal", "ga/gtotal", "na/kg"], a: 1, explanation: "Mole Fraction (X) is defined as the moles of a component divided by the TOTAL moles of all components in the mixture." },
                { id: 18, q: "NaCl + Ice temp:", options: ["-5", "-20", "-50", "0"], a: 1, explanation: "Adding NaCl to ice depresses the freezing point significantly, allowing the mixture to reach temperatures around -20°C to -21°C." },
                { id: 19, q: "Tyndall effect seen in:", options: ["Solutions.", "Colloids.", "Solvents.", "Gases."], a: 1, explanation: "The Tyndall effect is the scattering of light by particles. It occurs in Colloids (and suspensions) because the particles are large enough to scatter light, unlike true solutions." },
                { id: 20, q: "Mass %:", options: ["m_solute/m_solution", "m_solute/m_solvent", "n/V", "m*100"], a: 0, explanation: "Mass Percent = (Mass of Solute / Mass of Solution) * 100%. Note that solution mass = solute + solvent." }
            ],
            "lec3": [
                { id: 1, q: "Reaction Rate unit:", options: ["atm/L", "M/s", "K/s", "g/L"], a: 1, explanation: "Reaction rate represents the change in concentration per unit time. Concentration is Molarity (M) and time is usually seconds (s), so unit is M/s." },
                { id: 2, q: "2A -> B, Rate relative to A:", options: ["d[A]/dt", "-1/2 d[A]/dt", "2 d[A]/dt", "d[A]"], a: 1, explanation: "Rate is expressed as -(1/a) * d[A]/dt for reactants. Since coefficient is 2, it is -1/2 d[A]/dt." },
                { id: 3, q: "Rate = k[A][B], Order?", options: ["0", "1", "2", "3"], a: 2, explanation: "The overall reaction order is the sum of the exponents in the rate law. Here: 1 (for A) + 1 (for B) = 2 (Second Order)." },
                { id: 4, q: "1st Order Integrated Law:", options: ["[A]-kt", "ln[A]0-kt", "1/[A]", "Rate=k"], a: 1, explanation: "For a first-order reaction, the integrated rate law is ln[A] = -kt + ln[A]0." },
                { id: 5, q: "Slope of ln[A] vs t:", options: ["k", "-k", "1/k", "Ea"], a: 1, explanation: "From the linear equation y = mx + c (ln[A] = -kt + ln[A]0), the slope m corresponds to -k." },
                { id: 6, q: "1st Order Half-life depends on:", options: ["Conc.", "k only.", "Product.", "P."], a: 1, explanation: "t(1/2) = 0.693 / k. Notice there is no concentration term. Half-life is constant for first-order reactions." },
                { id: 7, q: "1/[A] vs t linear -> Order:", options: ["0", "1", "2", "3"], a: 2, explanation: "If the plot of 1/[A] versus time yields a straight line, the reaction follows second-order kinetics." },
                { id: 8, q: "Min energy for reaction:", options: ["H", "G", "Ea", "KE"], a: 2, explanation: "Activation Energy (Ea) is the minimum kinetic energy reactant molecules must possess to overcome the barrier and react." },
                { id: 9, q: "Arrhenius relates k to:", options: ["Conc.", "T and Ea.", "P.", "V."], a: 1, explanation: "The Arrhenius equation is k = A * exp(-Ea/RT). It describes the dependence of the rate constant (k) on Temperature (T) and Activation Energy (Ea)." },
                { id: 10, q: "Catalyst:", options: ["Inc T.", "Lowers Ea.", "Inc Conc.", "Shifts K."], a: 1, explanation: "A catalyst speeds up a reaction by providing an alternative pathway with a lower Activation Energy (Ea)." },
                { id: 11, q: "Slowest step is:", options: ["Initial.", "Term.", "Rate-determining.", "Fast."], a: 2, explanation: "The rate-determining step is the slowest step in a reaction mechanism, acting as a bottleneck that limits the overall rate." },
                { id: 12, q: "Intermediate:", options: ["Prod then Cons.", "Cons then Prod.", "Start/End.", "Hidden."], a: 1, explanation: "An intermediate is a species that is produced in an early step of the mechanism and consumed in a later step. It does not appear in the overall balanced equation." },
                { id: 13, q: "A+B -> Prod molecularity:", options: ["Uni", "Bi", "Ter", "Zero"], a: 1, explanation: "Molecularity refers to the number of particles colliding in an elementary step. A + B involves two particles, so it is Bimolecular." },
                { id: 14, q: "[A]x2 -> Rate x2. Order:", options: ["0", "1", "2", "3"], a: 1, explanation: "If doubling concentration (2x) leads to doubling the rate (2x), then 2^n = 2, so order n = 1." },
                { id: 15, q: "Rate=k[NO2]^2. Order:", options: ["Uni", "1", "2", "0"], a: 2, explanation: "The exponent determines the order. Since it is [NO2]^2, the reaction is second order with respect to NO2." },
                { id: 16, q: "Arrhenius slope:", options: ["-Ea/R", "Ea", "A", "R"], a: 0, explanation: "The linearized Arrhenius equation is ln(k) = (-Ea/R)(1/T) + ln(A). The slope of the graph ln(k) vs 1/T is -Ea/R." },
                { id: 17, q: "Heterogeneous catalyst:", options: ["Same phase.", "Diff phase.", "Liquid.", "Gas."], a: 1, explanation: "Heterogeneous means different phases. Typically, the catalyst is a solid and the reactants are gases or liquids." },
                { id: 18, q: "Collision theory needs:", options: ["Speed.", "Orientation+Ea.", "Vol.", "Cat."], a: 1, explanation: "For a reaction to occur, molecules must collide with: 1. Sufficient Energy (>= Ea) AND 2. Correct Orientation." },
                { id: 19, q: "Zero order k units:", options: ["s-1", "M/s", "M-1s-1", "None"], a: 1, explanation: "For Zero Order, Rate = k. Since Rate units are M/s, the units of k must also be M/s." },
                { id: 20, q: "Van't Hoff rule: Rate inc per:", options: ["1C", "10C", "100C", "1K"], a: 1, explanation: "The Van't Hoff rule is an empirical rule stating that reaction rate typically doubles or triples for every 10°C rise in temperature." }
            ],
            "lec4": [
                { id: 1, q: "At equilibrium, rates are:", options: ["Zero.", "Equal.", "Diff.", "Random."], a: 1, explanation: "Chemical equilibrium is a dynamic state where the rate of the forward reaction equals the rate of the reverse reaction." },
                { id: 2, q: "K expression:", options: ["Prod/React", "React/Prod", "Sum", "Diff"], a: 0, explanation: "The Law of Mass Action states that K = [Products] / [Reactants], with each concentration raised to the power of its stoichiometric coefficient." },
                { id: 3, q: "N2O4 <-> 2NO2 Keq:", options: ["[NO2]/[N2O4]", "[NO2]^2/[N2O4]", "Inverse", "Rate"], a: 1, explanation: "Products over reactants. NO2 is the product and has a coefficient of 2, so it becomes [NO2]^2." },
                { id: 4, q: "K >> 1 favors:", options: ["Reactants.", "Products.", "Neither.", "Solids."], a: 1, explanation: "If K is very large, the numerator (products) must be much larger than the denominator (reactants), meaning equilibrium favors products." },
                { id: 5, q: "Pure solids/liquids in K:", options: ["Included.", "Excluded.", "Zero.", "Var."], a: 1, explanation: "The concentration (activity) of pure solids and liquids is effectively constant (unity), so they are excluded from the equilibrium expression." },
                { id: 6, q: "Q < K shifts:", options: ["Right.", "Left.", "None.", "Stop."], a: 0, explanation: "If Q < K, the ratio of products/reactants is too small. The reaction must proceed forward (Right) to make more products and reach K." },
                { id: 7, q: "Kp vs Kc:", options: ["Equal", "Kp=Kc(RT)^dn", "Div", "Mult"], a: 1, explanation: "The relationship is Kp = Kc(RT)^Δn, where Δn is the change in moles of GAS (products - reactants)." },
                { id: 8, q: "Exothermic + Heat shifts:", options: ["Right.", "Left.", "None.", "Inc K."], a: 1, explanation: "In an exothermic reaction, Heat is a product. Adding heat shifts the equilibrium to the Left (Reactants) to consume the excess heat (Le Chatelier)." },
                { id: 9, q: "Inc Pressure shifts to:", options: ["Less gas moles.", "More moles.", "None.", "Reactants."], a: 0, explanation: "Increasing pressure (by reducing volume) stresses the system. The system relieves stress by shifting to the side with FEWER moles of gas." },
                { id: 10, q: "Catalyst changes:", options: ["K.", "Position.", "Rate.", "H."], a: 2, explanation: "A catalyst speeds up both forward and reverse reactions equally. It helps reach equilibrium faster but does NOT change K or the position of equilibrium." },
                { id: 11, q: "H2+I2<->2HI Pressure effect:", options: ["Right.", "Left.", "None.", "K."], a: 2, explanation: "Reactants: 2 moles gas. Products: 2 moles gas. Δn = 0. Since mole numbers are equal, pressure changes have no effect on the equilibrium position." },
                { id: 12, q: "K calc uses concentrations at:", options: ["Start.", "Equilibrium.", "Max.", "Min."], a: 1, explanation: "The Equilibrium Constant (K) is essentially defined by the ratio of concentrations measured specifically AT equilibrium." },
                { id: 13, q: "Rxn x2, new K:", options: ["2K", "K^2", "sqrtK", "K/2"], a: 1, explanation: "If you multiply a chemical equation by a factor n, the new equilibrium constant is the original K raised to the power of n. (K^2)." },
                { id: 14, q: "Rxn reversed, new K:", options: ["-K", "1/K", "K", "sqrtK"], a: 1, explanation: "If you reverse a reaction, the products become reactants and vice versa. The expression inverts, so K_new = 1/K_old." },
                { id: 15, q: "Remove NH3 (product):", options: ["Shift Left.", "Shift Right.", "None.", "Low K."], a: 1, explanation: "Removing a product lowers its concentration. Q becomes < K. The system shifts Right (Forward) to replace the removed product." },
                { id: 16, q: "Activity of solid:", options: ["0", "1", "Var", "Inf"], a: 1, explanation: "In thermodynamics, the activity of a pure solid or liquid in its standard state is defined as 1." },
                { id: 17, q: "Q uses concs at:", options: ["Equil.", "Any time.", "Prod.", "React."], a: 1, explanation: "The Reaction Quotient (Q) has the same form as K, but is calculated using concentrations at ANY specific moment in time (usually initial), not necessarily equilibrium." },
                { id: 18, q: "Resp. Acidosis (Excess CO2) shifts:", options: ["Right (H+ up).", "Left.", "None.", "Gas."], a: 0, explanation: "Buffer: CO2 + H2O <-> H+ + HCO3-. Excess CO2 is excess reactant. Equilibrium shifts Right, producing more H+, causing Acidosis." },
                { id: 19, q: "Ksp is for:", options: ["Gases.", "Salts.", "Liq.", "Acids."], a: 1, explanation: "Ksp (Solubility Product Constant) describes the equilibrium between a solid ionic compound (salt) and its dissolved ions in a saturated solution." },
                { id: 20, q: "Factor changing K value:", options: ["Rate.", "Pos.", "Temp.", "P."], a: 2, explanation: "Concentration and Pressure shift the *position* of equilibrium to maintain K. Only a change in Temperature changes the actual numerical value of K." }
            ]
        };

        // --- SETUP ---
        const urlParams = new URLSearchParams(window.location.search);
        const topic = urlParams.get('topic') || 'lec1';
        const questions = questionBank[topic] || [];
        
        // **IMPORTANT:** These titles MUST match the ones in ranking.html EXACTLY.
        const titles = { 
            'bioethics': "Bioethics Final", 
            'lec1': "Lec 01: Basics & Gases", 
            'lec2': "Lec 02: Solutions", 
            'lec3': "Lec 03: Kinetics", 
            'lec4': "Lec 04: Equilibrium" 
        };
        
        document.getElementById('quiz-title-display').innerText = titles[topic] || "Exam";
        document.getElementById('q-total').innerText = questions.length;
        document.getElementById('q-total-start').innerText = questions.length;

        // --- CORE LOGIC ---
        let currentIndex = 0, userAnswers = new Array(questions.length).fill(null), score = 0, timerInterval, timeLeft = 45 * 60, studentName = "";

        window.startQuiz = function() {
            const input = document.getElementById('student-name-input');
            const name = input.value.trim();
            if (!name) { input.classList.add('border-red-500', 'animate-pulse'); setTimeout(() => input.classList.remove('border-red-500', 'animate-pulse'), 1000); return; }
            studentName = name;
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('quiz-screen').classList.add('flex');
            document.getElementById('exit-btn').classList.add('hidden');
            document.getElementById('progress-container').classList.remove('hidden');
            renderQuestion(0);
            startTimer();
        };

        window.renderQuestion = function(index) {
            if (index >= questions.length) return;
            const q = questions[index];
            document.getElementById('q-number').innerText = index + 1;
            document.getElementById('q-text').innerText = q.q;
            document.getElementById('progress-bar').style.width = `${((index + 1) / questions.length) * 100}%`;
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            q.options.forEach((opt, optIndex) => {
                const div = document.createElement('div');
                const isSelected = userAnswers[index] === optIndex;
                div.className = `option-card cursor-pointer p-4 md:p-5 rounded-xl border border-white/10 flex items-center gap-4 ${isSelected ? 'option-selected' : 'bg-white/5 hover:bg-white/10'}`;
                div.onclick = () => { userAnswers[index] = optIndex; renderQuestion(index); };
                div.innerHTML = `<div class="w-6 h-6 rounded-full border-2 border-gray-500 shrink-0 flex items-center justify-center transition-colors ${isSelected ? 'border-primary' : ''}">${isSelected ? '<div class="w-3 h-3 rounded-full bg-primary"></div>' : ''}</div><span class="text-gray-300 font-medium ${isSelected ? 'text-white' : ''}">${opt}</span>`;
                container.appendChild(div);
            });
            document.getElementById('prev-btn').disabled = index === 0;
            document.getElementById('prev-btn').classList.toggle('opacity-50', index === 0);
            const nextBtn = document.getElementById('next-btn');
            if (index === questions.length - 1) {
                nextBtn.innerHTML = 'Finish <i class="fa-solid fa-flag-checkered ml-2"></i>';
                nextBtn.onclick = finishExam;
                nextBtn.className = "px-8 py-3 rounded-xl bg-primary text-white font-bold hover:bg-red-700 shadow-lg transition flex items-center gap-2 transform active:scale-95";
            } else {
                nextBtn.innerHTML = 'Next <i class="fa-solid fa-chevron-right ml-2"></i>';
                nextBtn.onclick = () => { currentIndex++; renderQuestion(currentIndex); };
                nextBtn.className = "px-8 py-3 rounded-xl bg-white text-black font-bold hover:bg-gray-200 shadow-lg transition flex items-center gap-2 transform active:scale-95";
            }
        };

        window.prevQuestion = function() { if(currentIndex > 0) { currentIndex--; renderQuestion(currentIndex); } };
        window.nextQuestion = function() { if(currentIndex < questions.length - 1) { currentIndex++; renderQuestion(currentIndex); } };

        window.finishExam = async function() {
            clearInterval(timerInterval);
            score = 0;
            userAnswers.forEach((ans, idx) => { if (ans === questions[idx].a) score++; });
            document.getElementById('final-score').innerText = score;
            document.getElementById('student-name-display').innerText = studentName;
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('progress-container').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            // --- FIX: UPDATE RANK BUTTON LINK ---
            const rankTopic = (topic === 'bioethics') ? 'bio' : topic; // map 'bioethics' back to 'bio'
            document.getElementById('rank-btn').href = `ranking.html?filter=${rankTopic}`;

            const statusEl = document.getElementById('save-status');
            try {
                // --- FIX: SAVE CORRECT SUBJECT NAME ---
                await addDoc(collection(db, "leaderboard"), {
                    name: studentName, 
                    score: score, 
                    total: questions.length, 
                    subject: titles[topic] || topic, 
                    timestamp: serverTimestamp()
                });
                statusEl.innerHTML = '<span class="text-green-400 font-bold flex items-center gap-2"><i class="fa-solid fa-check-circle"></i> Saved to Leaderboard</span>';
                statusEl.classList.add('bg-green-500/10', 'border-green-500/30');
            } catch (e) {
                statusEl.innerHTML = '<span class="text-red-400 font-bold flex items-center gap-2"><i class="fa-solid fa-circle-exclamation"></i> Save Failed</span>';
                statusEl.classList.add('bg-red-500/10', 'border-red-500/30');
            }
        };

        window.showReview = function() {
            const container = document.getElementById('review-container');
            container.innerHTML = '';
            questions.forEach((q, idx) => {
                const userChoice = userAnswers[idx];
                const correctChoice = q.a;
                const isCorrect = userChoice === correctChoice;
                let optionsHTML = '';
                q.options.forEach((opt, optIdx) => {
                    let optClass = "review-card-neutral p-4 rounded-xl mb-3 text-sm text-gray-400 flex justify-between items-center transition-all";
                    let icon = "", label = "";
                    if (optIdx === correctChoice) { optClass = "review-card-correct p-4 rounded-xl mb-3 text-sm font-bold text-green-400 flex justify-between items-center"; icon = '<i class="fa-solid fa-check-circle text-lg"></i>'; label = '<span class="text-[10px] uppercase tracking-wider border border-green-500/30 px-2 py-1 rounded bg-green-500/10 mr-2">Correct Answer</span>'; }
                    if (optIdx === userChoice) {
                         if (!isCorrect) { optClass = "review-card-wrong p-4 rounded-xl mb-3 text-sm font-bold text-red-400 flex justify-between items-center"; icon = '<i class="fa-solid fa-circle-xmark text-lg"></i>'; label = '<span class="text-[10px] uppercase tracking-wider border border-red-500/30 px-2 py-1 rounded bg-red-500/10 mr-2">Your Answer</span>'; }
                         else { label = '<span class="text-[10px] uppercase tracking-wider border border-green-500/30 px-2 py-1 rounded bg-green-500/10 mr-2">Your Answer</span>'; }
                    }
                    optionsHTML += `<div class="${optClass}"><span>${opt}</span><div class="flex items-center gap-2">${label} ${icon}</div></div>`;
                });
                const qBlock = document.createElement('div');
                qBlock.className = "bg-white/5 border border-white/10 rounded-2xl p-6 shadow-lg mb-6 relative overflow-hidden";
                qBlock.innerHTML = `<div class="absolute top-0 right-0 w-24 h-24 bg-white/5 rounded-bl-full -mr-4 -mt-4 pointer-events-none"></div><div class="flex gap-4 mb-6"><span class="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold shrink-0 shadow-lg ${isCorrect ? 'bg-green-500 text-black' : 'bg-red-500 text-white'}">${idx+1}</span><h3 class="font-bold text-lg leading-relaxed text-gray-100">${q.q}</h3></div><div class="pl-0 md:pl-12 mb-6">${optionsHTML}</div><div class="pl-0 md:pl-12"><div class="explanation-box p-5 rounded-xl relative overflow-hidden"><div class="flex items-center gap-2 text-blue-400 text-xs font-bold uppercase tracking-widest mb-2"><i class="fa-solid fa-lightbulb"></i> Explanation</div><p class="text-gray-300 text-sm leading-relaxed">${q.explanation}</p></div></div>`;
                container.appendChild(qBlock);
            });
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('review-screen').classList.remove('hidden');
        };

        window.closeReview = function() { document.getElementById('review-screen').classList.add('hidden'); document.getElementById('result-screen').classList.remove('hidden'); };
        function startTimer() { updateTimerDisplay(); timerInterval = setInterval(() => { timeLeft--; updateTimerDisplay(); if (timeLeft <= 0) finishExam(); }, 1000); }
        function updateTimerDisplay() { const m = Math.floor(timeLeft / 60); const s = timeLeft % 60; document.getElementById('timer-display').innerText = `${m}:${s < 10 ? '0' : ''}${s}`; }
    </script>
</body>
</html>
