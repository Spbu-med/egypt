<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Chemistry Exam - Secure Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: '#ff0033', dark: '#0a0a0a', glass: 'rgba(255, 255, 255, 0.05)' }, fontFamily: { cairo: ['Cairo', 'sans-serif'] }, animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' } } }
        }
    </script>
    <style>
        /* Anti-Cheat Styles */
        body { 
            background-color: #0a0a0a; 
            color: white; 
            font-family: 'Cairo', sans-serif; 
            background: radial-gradient(circle at 50% 50%, #1a0000 0%, #0a0a0a 100%); 
            min-height: 100vh; 
            overflow-x: hidden;
            user-select: none; /* Prevent text selection */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .blur-content { filter: blur(8px); pointer-events: none; }
        .warning-overlay { position: fixed; inset: 0; background: rgba(255,0,0,0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }

        .glass-panel { background: rgba(20, 20, 20, 0.75); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 20px 50px rgba(0,0,0,0.6); }
        .custom-input { background: rgba(0,0,0,0.4); border: 2px solid rgba(255,255,255,0.1); color: white; transition: 0.3s all ease; }
        .custom-input:focus { border-color: #ff0033; outline: none; box-shadow: 0 0 20px rgba(255, 0, 51, 0.15); background: rgba(0,0,0,0.8); transform: translateY(-2px); }
        .option-card { transition: all 0.2s ease; position: relative; overflow: hidden; }
        .option-card:hover { border-color: rgba(255, 0, 51, 0.6); background: rgba(255, 0, 51, 0.05); transform: translateX(5px); }
        .option-selected { border-color: #ff0033 !important; background: linear-gradient(90deg, rgba(255,0,51,0.2) 0%, transparent 100%) !important; box-shadow: -4px 0 0 #ff0033 inset; }
        .review-card-correct { background: linear-gradient(90deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.05) 100%) !important; border: 1px solid #22c55e !important; }
        .review-card-wrong { background: linear-gradient(90deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%) !important; border: 1px solid #ef4444 !important; opacity: 0.9; }
        .review-card-neutral { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); opacity: 0.6; }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .explanation-box { background: linear-gradient(180deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%); border-left: 4px solid #3b82f6; }
        .katex { font-size: 1.1em; line-height: 1.2; }
        .katex-display { margin: 0.5em 0; }
    </style>
</head>
<body class="flex flex-col h-screen" oncontextmenu="return false;">

    <div id="security-warning" class="hidden warning-overlay fade-in">
        <i class="fa-solid fa-triangle-exclamation text-6xl text-white mb-4 animate-bounce"></i>
        <h2 class="text-4xl font-black uppercase tracking-widest mb-2">Security Alert</h2>
        <p class="text-xl max-w-lg mb-8">You navigated away from the exam window. This action has been recorded.</p>
        <button onclick="resumeExam()" class="px-8 py-3 bg-white text-red-600 font-bold rounded-full hover:scale-105 transition">Resume Exam</button>
    </div>

    <header class="glass-panel h-16 flex items-center justify-between px-6 z-30 border-b border-white/5 relative">
        <h1 class="text-lg md:text-xl font-bold flex items-center gap-3 tracking-wide">
            <i class="fa-solid fa-shield-halved text-green-500"></i> 
            <span class="bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">Gen Chem Exam</span>
        </h1>
        <div id="timer-badge" class="hidden bg-red-600/20 text-red-500 px-4 py-1 rounded-full border border-red-500/50 font-mono font-bold flex items-center gap-2">
            <i class="fa-regular fa-clock animate-pulse"></i> <span id="timer-display">30:00</span>
        </div>
    </header>

    <div id="progress-container" class="hidden w-full h-1 bg-gray-800 z-20 absolute top-16 left-0"><div id="progress-bar" class="h-full bg-primary transition-all duration-500 ease-out" style="width: 0%"></div></div>

    <main class="flex-1 flex items-center justify-center p-4 relative overflow-hidden">
        
        <div id="start-screen" class="glass-panel max-w-md w-full p-8 md:p-10 rounded-3xl text-center fade-in border border-white/10 relative overflow-hidden">
            <div class="w-24 h-24 bg-gradient-to-br from-gray-800 to-black rounded-full flex items-center justify-center mx-auto mb-8 border border-white/10 shadow-2xl"><i class="fa-solid fa-atom text-4xl text-primary"></i></div>
            <h2 class="text-3xl font-black mb-2 tracking-tight">Chemistry Midterm</h2>
            <p class="text-gray-400 mb-8 text-sm leading-relaxed">Secure Environment • 16 Questions • 30 Mins</p>
            
            <div class="text-left mb-6 group">
                <label class="text-xs text-primary font-bold uppercase tracking-widest ml-1 mb-2 block">Full Name</label>
                <input type="text" id="student-name-input" placeholder="Enter your full name..." class="custom-input w-full rounded-xl p-4 text-lg placeholder-gray-600">
            </div>

            <ul class="text-left text-xs text-gray-500 mb-8 space-y-2 bg-white/5 p-4 rounded-lg">
                <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> Fullscreen mode required</li>
                <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> Tab switching is monitored</li>
                <li class="flex items-center gap-2"><i class="fa-solid fa-ban text-red-500"></i> Copy/Paste disabled</li>
            </ul>

            <button onclick="requestFullScreenAndStart()" class="w-full bg-gradient-to-r from-primary to-red-700 hover:from-red-600 hover:to-red-800 text-white font-bold py-4 rounded-xl shadow-[0_10px_30px_rgba(255,0,51,0.3)] transition-all transform hover:scale-[1.02] flex items-center justify-center gap-3">
                <span>Enter Exam Mode</span> <i class="fa-solid fa-lock"></i>
            </button>
        </div>

        <div id="quiz-screen" class="hidden flex-col w-full max-w-4xl h-full md:h-auto fade-in">
            <div class="flex justify-between items-end mb-4 px-2">
                <div class="text-sm font-medium text-gray-400">Question <span id="q-number" class="text-white text-2xl font-bold font-cairo mx-1">1</span> / <span id="q-total">16</span></div>
            </div>
            <div class="glass-panel flex-1 md:flex-none rounded-2xl p-6 md:p-10 relative overflow-y-auto border-t-4 border-t-primary">
                <h2 id="q-text" class="text-xl md:text-2xl font-bold mb-8 leading-relaxed text-gray-100">Loading...</h2>
                <div id="options-container" class="space-y-3 pb-20 md:pb-0"></div>
            </div>
            <div class="flex justify-between mt-6">
                <button onclick="prevQuestion()" id="prev-btn" class="px-6 py-3 rounded-xl border border-white/10 hover:bg-white/5 text-gray-400 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition flex items-center gap-2"><i class="fa-solid fa-chevron-left"></i> Prev</button>
                <button onclick="nextQuestion()" id="next-btn" class="px-8 py-3 rounded-xl bg-white text-black font-bold hover:bg-gray-200 shadow-lg transition flex items-center gap-2 transform active:scale-95">Next <i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>

        <div id="result-screen" class="hidden glass-panel max-w-md w-full p-8 rounded-3xl text-center border border-white/10 fade-in relative z-50">
            <div class="w-28 h-28 rounded-full border-4 border-primary mx-auto flex flex-col items-center justify-center mb-6 shadow-[0_0_40px_rgba(255,0,51,0.4)] bg-black relative z-10">
                <span id="final-score" class="text-5xl font-black text-white leading-none mt-1">0</span>
                <span class="text-[10px] text-gray-400 uppercase tracking-widest mt-1">/ 16</span>
            </div>
            <h2 class="text-2xl font-bold mb-1">Exam Submitted</h2>
            <p id="student-name-display" class="text-primary font-bold text-lg mb-4"></p>
            
            <div id="violation-badge" class="hidden mb-4 py-2 px-4 bg-red-500/10 border border-red-500/50 rounded-lg text-red-400 text-xs font-bold">
                <i class="fa-solid fa-triangle-exclamation mr-1"></i> Security Violations Detected
            </div>

            <button onclick="showReview()" class="w-full py-3.5 bg-gradient-to-r from-gray-800 to-gray-900 border border-white/10 hover:border-primary/50 text-white font-bold rounded-xl transition-all flex items-center justify-center gap-2 group mb-3">
                <i class="fa-solid fa-eye text-primary group-hover:scale-110 transition-transform"></i> Review Answers
            </button>
            <button onclick="location.href='index.html'" class="w-full py-3 border border-white/10 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 text-sm transition">Exit Exam</button>
        </div>

        <div id="review-screen" class="hidden absolute inset-0 bg-[#0a0a0a] z-[60] flex flex-col fade-in">
            <div class="glass-panel p-4 flex justify-between items-center border-b border-white/10 shrink-0 sticky top-0 z-50">
                <h2 class="font-bold text-lg flex items-center gap-2 text-white"><i class="fa-solid fa-list-check text-primary"></i> Model Answer</h2>
                <button onclick="closeReview()" class="bg-white/5 hover:bg-white/10 border border-white/10 text-gray-300 px-4 py-2 rounded-lg transition text-sm">Close <i class="fa-solid fa-xmark ml-1"></i></button>
            </div>
            <div id="review-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 max-w-4xl mx-auto w-full pb-20 custom-scrollbar"></div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyASq2nOBpRMJtKqWWvTDD4hyGmEOp5cOnI", authDomain: "spbu-med-platform.firebaseapp.com", projectId: "spbu-med-platform", storageBucket: "spbu-med-platform.firebasestorage.app", messagingSenderId: "227576463828", appId: "1:227576463828:web:1114162c17881bf5da9641" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 16 QUESTIONS (CHEMISTRY) ---
        const questions = [
            { id: 1, q: "For the isotope Cobalt-60 in the $Co^{2+}$ state, determine the number of protons, neutrons, and electrons. (Z=27)", options: ["27p, 33n, 27e", "27p, 33n, 25e", "60p, 27n, 25e", "27p, 60n, 29e"], a: 1, explanation: "Protons = Z = 27. Neutrons = A - Z = 60 - 27 = 33. Electrons = 27 - 2 (charge) = 25." },
            { id: 2, q: "Gallium consists of two isotopes: $^{69}Ga$ (60.1% abundance, mass 68.926 u) and $^{71}Ga$ (39.9% abundance, mass 70.925 u). Calculate average atomic mass.", options: ["69.92 u", "69.72 u", "70.10 u", "69.00 u"], a: 1, explanation: "Avg = $(68.926 \\times 0.601) + (70.925 \\times 0.399) \\approx 69.72$ u." },
            { id: 3, q: "A balloon contains 2.50 L of Helium at $40^\\circ C$. It is cooled to $-10^\\circ C$ at constant pressure. What is the new volume?", options: ["2.10 L", "2.95 L", "0.62 L", "3.00 L"], a: 0, explanation: "Charles Law: $V_1/T_1 = V_2/T_2$. $2.5/(313) = V_2/(263)$. $V_2 \\approx 2.10$ L." },
            { id: 4, q: "How many moles of air are inhaled if a person breathes 0.75 L at $30^\\circ C$ and 0.95 atm? ($R=0.08206$)", options: ["0.045 mol", "0.029 mol", "0.290 mol", "34.5 mol"], a: 1, explanation: "$n = PV/RT = (0.95 \\times 0.75) / (0.08206 \\times 303) \\approx 0.029$ mol." },
            { id: 5, q: "A gas mixture has total pressure 5.0 atm. It contains 2 mol He, 3 mol Ne, and 5 mol Ar. What is the partial pressure of Ne?", options: ["1.0 atm", "1.5 atm", "2.5 atm", "3.0 atm"], a: 1, explanation: "Total moles = 10. $X_{Ne} = 3/10 = 0.3$. $P_{Ne} = 0.3 \\times 5.0 = 1.5$ atm." },
            { id: 6, q: "How many grams of Glucose ($C_6H_{12}O_6$) and water are needed to prepare 500 g of a 5.0% by mass solution?", options: ["25 g Glucose, 500 g Water", "5 g Glucose, 495 g Water", "25 g Glucose, 475 g Water", "50 g Glucose, 450 g Water"], a: 2, explanation: "$5\\%$ of 500g = 25g solute. Solvent = $500 - 25 = 475$g." },
            { id: 7, q: "To prepare 250 mL of 0.50 M $H_2SO_4$ from a stock solution of 18.0 M $H_2SO_4$, how much stock do you need?", options: ["13.9 mL", "6.9 mL", "36 mL", "1.8 mL"], a: 1, explanation: "$M_1V_1 = M_2V_2$. $(18)V_1 = (0.5)(250)$. $V_1 = 6.94$ mL." },
            { id: 8, q: "Dissolve 20.0 g of NaOH (M=40.0 g/mol) in 250 g of water. Calculate the Molality (m).", options: ["2.00 m", "0.20 m", "0.80 m", "1.25 m"], a: 0, explanation: "Moles = $20/40 = 0.5$ mol. Kg solvent = 0.25 kg. $m = 0.5 / 0.25 = 2.0$ m." },
            { id: 9, q: "If the solubility of a gas is 0.5 g/L at 2.0 atm, what is its solubility at 6.0 atm at the same temperature?", options: ["1.0 g/L", "1.5 g/L", "3.0 g/L", "0.16 g/L"], a: 1, explanation: "Henry's Law: $S_1/P_1 = S_2/P_2$. $0.5/2 = S_2/6 \\to S_2 = 1.5$." },
            { id: 10, q: "Calculate the freezing point of a solution containing 0.5 mol of $CaCl_2$ in 1.0 kg of water. ($K_f = 1.86$). Note: $CaCl_2$ is a strong electrolyte.", options: ["-0.93 $^\\circ C$", "-1.86 $^\\circ C$", "-2.79 $^\\circ C$", "-5.58 $^\\circ C$"], a: 2, explanation: "$CaCl_2 \\to 3$ ions ($i=3$). $\\Delta T = i \\cdot K_f \\cdot m = 3 \\times 1.86 \\times 0.5 = 2.79$. FP = -2.79 C." },
            { id: 11, q: "Calculate the osmotic pressure of 0.10 M $Na_2SO_4$ solution at $27^\\circ C$. (Assume complete dissociation, $i=3$)", options: ["2.46 atm", "7.39 atm", "4.92 atm", "0.82 atm"], a: 1, explanation: "$\\pi = iMRT$. $i=3$. $T=300K$. $\\pi = 3 \\times 0.10 \\times 0.08206 \\times 300 \\approx 7.39$ atm." },
            { id: 12, q: "Reaction: $2NaN_3(s) \\to 2Na(s) + 3N_2(g)$. How many liters of $N_2$ are produced at STP from decomposition of 65.0 g $NaN_3$? (M=65.0 g/mol)", options: ["22.4 L", "44.8 L", "33.6 L", "67.2 L"], a: 2, explanation: "Moles $NaN_3 = 1$. Moles $N_2 = 1 \\times (3/2) = 1.5$ mol. Vol = $1.5 \\times 22.4 = 33.6$ L." },
            { id: 13, q: "An unknown gas has a density of 1.96 g/L at STP. Calculate its Molar Mass.", options: ["28 g/mol", "44 g/mol", "16 g/mol", "32 g/mol"], a: 1, explanation: "At STP, 1 mol = 22.4 L. $M = d \\times 22.4 = 1.96 \\times 22.4 \\approx 43.9$ g/mol ($CO_2$)." },
            { id: 14, q: "Which of the following will have the LOWEST vapor pressure at $25^\\circ C$?", options: ["Pure water", "0.1 M Glucose", "0.1 M NaCl", "0.1 M $AlCl_3$"], a: 3, explanation: "Lowest VP = Highest solute concentration (particles). $AlCl_3$ gives 4 particles ($i=4$), causing max depression." },
            { id: 15, q: "What is the mass percent of Carbon in Acetone $C_3H_6O$? (C=12, H=1, O=16)", options: ["62.1 %", "50.0 %", "40.0 %", "20.7 %"], a: 0, explanation: "MW = 58. Mass C = $3 \\times 12 = 36$. $\\% = (36/58) \\times 100 = 62.06\\%$." },
            { id: 16, q: "Adding a catalyst to a reaction increases the rate by:", options: ["Increasing collision frequency", "Lowering Activation Energy ($E_a$)", "Increasing Temperature", "Increasing $\\Delta H$"], a: 1, explanation: "Catalysts provide an alternative pathway with lower Activation Energy." }
        ];

        // --- CORE LOGIC ---
        let currentIndex = 0;
        let userAnswers = new Array(questions.length).fill(null);
        let score = 0;
        let timerInterval;
        let timeLeft = 30 * 60; // 30 Minutes
        let studentName = "";
        let violations = 0;

        // Make functions global
        window.requestFullScreenAndStart = async function() {
            const elem = document.documentElement;
            try {
                if (elem.requestFullscreen) { await elem.requestFullscreen(); }
                else if (elem.webkitRequestFullscreen) { await elem.webkitRequestFullscreen(); }
                startQuiz();
            } catch (err) {
                alert("Fullscreen mode is required for security.");
            }
        };

        window.resumeExam = function() {
            document.getElementById('security-warning').classList.add('hidden');
        };

        window.startQuiz = function() {
            const input = document.getElementById('student-name-input');
            const name = input.value.trim();
            if (!name) { input.classList.add('border-red-500', 'animate-pulse'); setTimeout(() => input.classList.remove('border-red-500', 'animate-pulse'), 1000); return; }
            studentName = name;
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('quiz-screen').classList.add('flex');
            document.getElementById('timer-badge').classList.remove('hidden');
            document.getElementById('progress-container').classList.remove('hidden');
            
            renderQuestion(0);
            startTimer();
        };

        // Detect Tab Switching
        document.addEventListener("visibilitychange", () => {
            if (document.hidden && document.getElementById('quiz-screen').style.display === 'flex') {
                violations++;
                document.getElementById('security-warning').classList.remove('hidden');
            }
        });

        // Block Keys
        document.onkeydown = function(e) {
            if (e.keyCode == 123) { return false; } // F12
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; } // Ctrl+Shift+I
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; } // Ctrl+U
        };

        window.renderQuestion = function(index) {
            const q = questions[index];
            document.getElementById('q-number').innerText = index + 1;
            const qTextEl = document.getElementById('q-text');
            qTextEl.innerHTML = q.q; 
            
            document.getElementById('progress-bar').style.width = `${((index + 1) / questions.length) * 100}%`;
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            q.options.forEach((opt, optIndex) => {
                const div = document.createElement('div');
                const isSelected = userAnswers[index] === optIndex;
                div.className = `option-card cursor-pointer p-4 md:p-5 rounded-xl border border-white/10 flex items-center gap-4 ${isSelected ? 'option-selected' : 'bg-white/5 hover:bg-white/10'}`;
                div.onclick = () => { userAnswers[index] = optIndex; renderQuestion(index); };
                div.innerHTML = `<div class="w-6 h-6 rounded-full border-2 border-gray-500 shrink-0 flex items-center justify-center transition-colors ${isSelected ? 'border-primary' : ''}">${isSelected ? '<div class="w-3 h-3 rounded-full bg-primary"></div>' : ''}</div><span class="text-gray-300 font-medium ${isSelected ? 'text-white' : ''}">${opt}</span>`;
                container.appendChild(div);
            });

            // KaTeX Rendering
            renderMathInElement(qTextEl, { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}] });
            renderMathInElement(container, { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}] });

            document.getElementById('prev-btn').disabled = index === 0;
            document.getElementById('prev-btn').classList.toggle('opacity-50', index === 0);
            
            const nextBtn = document.getElementById('next-btn');
            if (index === questions.length - 1) {
                nextBtn.innerHTML = 'Submit Exam <i class="fa-solid fa-lock ml-2"></i>';
                nextBtn.onclick = finishExam;
                nextBtn.className = "px-8 py-3 rounded-xl bg-primary text-white font-bold hover:bg-red-700 shadow-lg transition flex items-center gap-2 transform active:scale-95";
            } else {
                nextBtn.innerHTML = 'Next <i class="fa-solid fa-chevron-right ml-2"></i>';
                nextBtn.onclick = () => { currentIndex++; renderQuestion(currentIndex); };
                nextBtn.className = "px-8 py-3 rounded-xl bg-white text-black font-bold hover:bg-gray-200 shadow-lg transition flex items-center gap-2 transform active:scale-95";
            }
        };

        window.prevQuestion = function() { if(currentIndex > 0) { currentIndex--; renderQuestion(currentIndex); } };
        window.nextQuestion = function() { if(currentIndex < questions.length - 1) { currentIndex++; renderQuestion(currentIndex); } };

        window.finishExam = async function() {
            clearInterval(timerInterval);
            score = 0;
            userAnswers.forEach((ans, idx) => { if (ans === questions[idx].a) score++; });
            
            document.getElementById('final-score').innerText = score;
            document.getElementById('student-name-display').innerText = studentName;
            
            // Show Status
            const saveIndicator = document.createElement('div');
            saveIndicator.className = 'mb-4 py-2 px-4 rounded-lg bg-white/5 border border-white/10 text-xs font-mono inline-flex items-center gap-2';
            saveIndicator.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-primary"></i> Syncing Score...';
            document.getElementById('result-screen').insertBefore(saveIndicator, document.getElementById('violation-badge'));

            // SAVE TO FIREBASE
            try {
                await addDoc(collection(db, "leaderboard"), {
                    name: studentName, 
                    score: score, 
                    total: questions.length, 
                    subject: 'General Chemistry Midterm', // Matches ranking.html
                    timestamp: serverTimestamp(),
                    violations: violations
                });
                saveIndicator.innerHTML = '<span class="text-green-400"><i class="fa-solid fa-check"></i> Score Saved!</span>';
                saveIndicator.classList.add('border-green-500/30', 'bg-green-500/10');
            } catch (e) {
                console.error("Error adding document: ", e);
                saveIndicator.innerHTML = '<span class="text-red-400"><i class="fa-solid fa-triangle-exclamation"></i> Save Failed</span>';
            }

            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('timer-badge').classList.add('hidden');
            document.getElementById('progress-container').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');

            if (violations > 0) {
                const badge = document.getElementById('violation-badge');
                badge.classList.remove('hidden');
                badge.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-1"></i> ${violations} Security Violations Recorded`;
            }
            
            if (document.exitFullscreen) document.exitFullscreen();
        };

        window.showReview = function() {
            const container = document.getElementById('review-container');
            container.innerHTML = '';
            questions.forEach((q, idx) => {
                const userChoice = userAnswers[idx];
                const isCorrect = userChoice === q.a;
                let optionsHTML = '';
                q.options.forEach((opt, optIdx) => {
                    let optClass = "review-card-neutral p-4 rounded-xl mb-3 text-sm text-gray-400 flex justify-between items-center transition-all";
                    let icon = "";
                    if (optIdx === q.a) { optClass = "review-card-correct p-4 rounded-xl mb-3 text-sm font-bold text-green-400 flex justify-between items-center"; icon = '<i class="fa-solid fa-check-circle text-lg"></i>'; }
                    if (optIdx === userChoice) {
                         if (!isCorrect) { optClass = "review-card-wrong p-4 rounded-xl mb-3 text-sm font-bold text-red-400 flex justify-between items-center"; icon = '<i class="fa-solid fa-circle-xmark text-lg"></i>'; }
                    }
                    optionsHTML += `<div class="${optClass}"><span>${opt}</span><div class="flex items-center gap-2">${icon}</div></div>`;
                });
                
                const qBlock = document.createElement('div');
                qBlock.className = "bg-white/5 border border-white/10 rounded-2xl p-6 shadow-lg mb-6 relative overflow-hidden";
                qBlock.innerHTML = `<div class="flex gap-4 mb-6"><span class="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold shrink-0 shadow-lg ${isCorrect ? 'bg-green-500 text-black' : 'bg-red-500 text-white'}">${idx+1}</span><h3 class="font-bold text-lg leading-relaxed text-gray-100">${q.q}</h3></div><div class="pl-0 md:pl-12 mb-6">${optionsHTML}</div><div class="pl-0 md:pl-12"><div class="explanation-box p-5 rounded-xl"><div class="flex items-center gap-2 text-blue-400 text-xs font-bold uppercase tracking-widest mb-2"><i class="fa-solid fa-lightbulb"></i> Explanation</div><p class="text-gray-300 text-sm leading-relaxed">${q.explanation}</p></div></div>`;
                container.appendChild(qBlock);
            });
            renderMathInElement(container, { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}] });
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('review-screen').classList.remove('hidden');
        };

        window.closeReview = function() { document.getElementById('review-screen').classList.add('hidden'); document.getElementById('result-screen').classList.remove('hidden'); };
        
        function startTimer() { updateTimerDisplay(); timerInterval = setInterval(() => { timeLeft--; updateTimerDisplay(); if (timeLeft <= 0) finishExam(); }, 1000); }
        function updateTimerDisplay() { const m = Math.floor(timeLeft / 60); const s = timeLeft % 60; document.getElementById('timer-display').innerText = `${m}:${s < 10 ? '0' : ''}${s}`; }
    </script>
</body>
</html>
